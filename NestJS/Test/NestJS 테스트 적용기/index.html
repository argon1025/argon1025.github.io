<!DOCTYPE html>
<html>
<!-- Header -->
<head>
    
    
    
    
    

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Argon.Blog - 테스트란 무엇이며 어떻게 할까요?">
    <meta property="og:description" content="NestJS에서 Jest로 테스트코드 작성하기">
    <meta property="og:image" content="/feed-thumbnail/object14.jpg">
    <meta property="og:url" content="https://argon1025.github.io/NestJS/Test/NestJS 테스트 적용기/">
    <meta property="og:site_name" content="Argon.Blog - 테스트란 무엇이며 어떻게 할까요?">
    <!-- Open Graph End -->

    <!-- Title -->
    <title>Argon.Blog - 테스트란 무엇이며 어떻게 할까요?</title>
    <!-- Title End -->

    <!-- MetaData -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="title" content="Argon.Blog - 테스트란 무엇이며 어떻게 할까요?">
    <link rel="canonical" href="https://argon1025.github.io/NestJS/Test/NestJS 테스트 적용기/">
    <meta name="keywords" content="developer, NodeJS, NestJS" />
    <meta name="author" content="argon1025" />
    <meta name="description" content="NestJS에서 Jest로 테스트코드 작성하기" />
    <!-- MetaData End -->

    
        <link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous">
    

    
        <!-- Favicon -->
        <link rel="icon" href="/shape.svg">
        <link rel="shortcut icon" href="/shape.svg" />
        <link rel="apple-touch-icon" sizes="72x72" href="/shape.svg" />
        <link rel="apple-touch-icon" sizes="114x114"  href="/shape.svg" />
        <link rel="apple-touch-icon" sizes="144x144"  href="/shape.svg" />
        <!-- Favicon End  -->
    

    <!-- Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.6/dist/web/static/pretendard.css" />
    <!-- Font End -->

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
        theme: {
            extend: {
            fontFamily: {
                'sans': ['Pretendard Variable', 'Pretendard', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'Roboto', "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"],
            }
            }
        }
        }
    </script>
    <!-- TailwindCSS End -->

    <!-- highlight.js Theme -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <!-- highlight.js Theme End -->
<meta name="generator" content="Hexo 6.3.0"></head>
  <!-- Header End -->

  <body class="w-full h-full font-sans">
    <!-- Navigation -->
    <div>
      <div class="z-50 flex justify-center items-center w-full p-5 backdrop-blur-sm bg-white/60">
    <div class="flex flex-col w-full max-w-5xl justify-center items-center space-y-4 md:space-y-0 md:flex-row">
        <!-- Logo -->
        
            
                <a href="/">
                    <img src="/images/wind.png" alt="Argon.Blog" class="h-8">
                </a>
            
        
        <!-- Logo End -->
        
        <!-- Space -->
        <div class="flex grow"></div>
        <!-- Space End -->

        <!-- Menu -->
        <ul class="flex flex-row space-x-10">
        
            <li class="font-semibold hover:text-gray-400 transition duration-300 ease-in-out" data-path="/">
                <a href="/">Index</a>
            </li>
        
            <li class="font-semibold hover:text-gray-400 transition duration-300 ease-in-out" data-path="https://github.com/argon1025">
                <a target="_blank" rel="noopener" href="https://github.com/argon1025">GitHub</a>
            </li>
        
        </ul>
        <!-- Menu End -->
    </div>
</div>
    </div>
    <!-- Navigation End -->
    <!-- PostDetail -->
    <div class="flex flex-col w-full justify-center items-center space-y-5 p-5">
    <!-- Post Detail Header -->
    <div class="w-full max-w-5xl space-y-3">
      
      
      
      
      
      
      
      
      
      <!-- Header Category -->
      <div class="flex text-xs">
        <div class="flex flex-row rounded-md justify-center items-center space-x-1">
          <div class="w-3 h-3 fill-gray-400"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><title>NestJS</title><path d="M14.131.047c-.173 0-.334.037-.483.087.316.21.49.49.576.806.007.043.019.074.025.117a.681.681 0 0 1 .013.112c.024.545-.143.614-.26.936-.18.415-.13.861.086 1.22a.74.74 0 0 0 .074.137c-.235-1.568 1.073-1.803 1.314-2.293.019-.428-.334-.713-.613-.911a1.37 1.37 0 0 0-.732-.21zM16.102.4c-.024.143-.006.106-.012.18-.006.05-.006.112-.012.161-.013.05-.025.1-.044.149-.012.05-.03.1-.05.149l-.067.142c-.02.025-.031.05-.05.075l-.037.055a2.152 2.152 0 0 1-.093.124c-.037.038-.068.081-.112.112v.006c-.037.031-.074.068-.118.1-.13.099-.278.173-.415.266-.043.03-.087.056-.124.093a.906.906 0 0 0-.118.099c-.043.037-.074.074-.111.118-.031.037-.068.08-.093.124a1.582 1.582 0 0 0-.087.13c-.025.05-.043.093-.068.142-.019.05-.037.093-.05.143a2.007 2.007 0 0 0-.043.155c-.006.025-.006.056-.012.08-.007.025-.007.05-.013.075 0 .05-.006.105-.006.155 0 .037 0 .074.006.111 0 .05.006.1.019.155.006.05.018.1.03.15.02.049.032.098.05.148.013.03.031.062.044.087l-1.426-.552c-.241-.068-.477-.13-.719-.186l-.39-.093c-.372-.074-.75-.13-1.128-.167-.013 0-.019-.006-.031-.006A11.082 11.082 0 0 0 8.9 2.855c-.378.025-.756.074-1.134.136a12.45 12.45 0 0 0-.837.174l-.279.074c-.092.037-.18.08-.266.118l-.205.093c-.012.006-.024.006-.03.012-.063.031-.118.056-.174.087a2.738 2.738 0 0 0-.236.118c-.043.018-.086.043-.124.062a.559.559 0 0 1-.055.03c-.056.032-.112.063-.162.094a1.56 1.56 0 0 0-.148.093c-.044.03-.087.055-.124.086-.006.007-.013.007-.019.013-.037.025-.08.056-.118.087l-.012.012-.093.074c-.012.007-.025.019-.037.025-.031.025-.062.056-.093.08-.006.013-.019.02-.025.025-.037.038-.074.069-.111.106-.007 0-.007.006-.013.012a1.742 1.742 0 0 0-.111.106c-.007.006-.007.012-.013.012a1.454 1.454 0 0 0-.093.1c-.012.012-.03.024-.043.036a1.374 1.374 0 0 1-.106.112c-.006.012-.018.019-.024.03-.05.05-.093.1-.143.15l-.018.018c-.1.106-.205.211-.317.304-.111.1-.229.192-.347.273a3.777 3.777 0 0 1-.762.421c-.13.056-.267.106-.403.149-.26.056-.527.161-.756.18-.05 0-.105.012-.155.018l-.155.037-.149.056c-.05.019-.099.044-.148.068-.044.031-.093.056-.137.087a1.011 1.011 0 0 0-.124.106c-.043.03-.087.074-.124.111-.037.043-.074.08-.105.124-.031.05-.068.093-.093.143a1.092 1.092 0 0 0-.087.142c-.025.056-.05.106-.068.161-.019.05-.037.106-.056.161-.012.05-.025.1-.03.15 0 .005-.007.012-.007.018-.012.056-.012.13-.019.167C.006 7.95 0 7.986 0 8.03a.657.657 0 0 0 .074.31v.006c.019.037.044.075.069.112.024.037.05.074.08.111.031.031.068.069.106.1a.906.906 0 0 0 .117.099c.149.13.186.173.378.272.031.019.062.031.1.05.006 0 .012.006.018.006 0 .013 0 .019.006.031a1.272 1.272 0 0 0 .08.298c.02.037.032.074.05.111.007.013.013.025.02.031.024.05.049.093.073.137l.093.13c.031.037.069.08.106.118.037.037.074.068.118.105 0 0 .006.006.012.006.037.031.074.062.112.087a.986.986 0 0 0 .136.08c.043.025.093.05.142.069a.73.73 0 0 0 .124.043c.007.006.013.006.025.012.025.007.056.013.08.019-.018.335-.024.65.026.762.055.124.328-.254.6-.688-.036.428-.061.93 0 1.079.069.155.44-.329.763-.862 4.395-1.016 8.405 2.02 8.826 6.31-.08-.67-.905-1.041-1.283-.948-.186.458-.502 1.047-1.01 1.413.043-.41.025-.83-.062-1.24a4.009 4.009 0 0 1-.769 1.562c-.588.043-1.177-.242-1.487-.67-.025-.018-.031-.055-.05-.08-.018-.043-.037-.087-.05-.13a.515.515 0 0 1-.037-.13c-.006-.044-.006-.087-.006-.137v-.093a.992.992 0 0 1 .031-.13c.013-.043.025-.086.044-.13.024-.043.043-.087.074-.13.105-.298.105-.54-.087-.682a.706.706 0 0 0-.118-.062c-.024-.006-.055-.018-.08-.025l-.05-.018a.847.847 0 0 0-.13-.031.472.472 0 0 0-.13-.019 1.01 1.01 0 0 0-.136-.012c-.031 0-.062.006-.093.006a.484.484 0 0 0-.137.019c-.043.006-.086.012-.13.024a1.068 1.068 0 0 0-.13.044c-.043.018-.08.037-.124.056-.037.018-.074.043-.118.062-1.444.942-.582 3.148.403 3.787-.372.068-.75.148-.855.229l-.013.012c.267.161.546.298.837.416.397.13.818.247 1.004.297v.006a5.996 5.996 0 0 0 1.562.112c2.746-.192 4.996-2.281 5.405-5.033l.037.161c.019.112.043.23.056.347v.006c.012.056.018.112.025.162v.024c.006.056.012.112.012.162.006.068.012.136.012.204v.1c0 .03.007.067.007.098 0 .038-.007.075-.007.112v.087c0 .043-.006.08-.006.124 0 .025 0 .05-.006.08 0 .044-.006.087-.006.137-.006.018-.006.037-.006.055l-.02.143c0 .019 0 .037-.005.056-.007.062-.019.118-.025.18v.012l-.037.174v.018l-.037.167c0 .007-.007.02-.007.025a1.663 1.663 0 0 1-.043.168v.018c-.019.062-.037.118-.05.174-.006.006-.006.012-.006.012l-.056.186c-.024.062-.043.118-.068.18-.025.062-.043.124-.068.18-.025.062-.05.117-.074.18h-.007c-.024.055-.05.117-.08.173a.302.302 0 0 1-.019.043c-.006.006-.006.013-.012.019a5.867 5.867 0 0 1-1.742 2.082c-.05.031-.099.069-.149.106-.012.012-.03.018-.043.03a2.603 2.603 0 0 1-.136.094l.018.037h.007l.26-.037h.006c.161-.025.322-.056.483-.087.044-.006.093-.019.137-.031l.087-.019c.043-.006.086-.018.13-.024.037-.013.074-.02.111-.031.62-.15 1.221-.354 1.798-.595a9.926 9.926 0 0 1-3.85 3.142c.714-.05 1.426-.167 2.114-.366a9.903 9.903 0 0 0 5.857-4.68 9.893 9.893 0 0 1-1.667 3.986 9.758 9.758 0 0 0 1.655-1.376 9.824 9.824 0 0 0 2.61-5.268c.21.98.272 1.99.18 2.987 4.474-6.241.371-12.712-1.346-14.416-.006-.013-.012-.019-.012-.031-.006.006-.006.006-.006.012 0-.006 0-.006-.007-.012 0 .074-.006.148-.012.223a8.34 8.34 0 0 1-.062.415c-.03.136-.068.273-.105.41-.044.13-.093.266-.15.396a5.322 5.322 0 0 1-.185.378 4.735 4.735 0 0 1-.477.688c-.093.111-.192.21-.292.31a3.994 3.994 0 0 1-.18.155l-.142.124a3.459 3.459 0 0 1-.347.241 4.295 4.295 0 0 1-.366.211c-.13.062-.26.118-.39.174a4.364 4.364 0 0 1-.818.223c-.143.025-.285.037-.422.05a4.914 4.914 0 0 1-.297.012 4.66 4.66 0 0 1-.422-.025 3.137 3.137 0 0 1-.421-.062 3.136 3.136 0 0 1-.415-.105h-.007c.137-.013.273-.025.41-.05a4.493 4.493 0 0 0 .818-.223c.136-.05.266-.112.39-.174.13-.062.248-.13.372-.204.118-.08.235-.161.347-.248.112-.087.217-.18.316-.279.105-.093.198-.198.291-.304.093-.111.18-.223.26-.334.013-.019.026-.044.038-.062.062-.1.124-.199.18-.298a4.272 4.272 0 0 0 .334-.775c.044-.13.075-.266.106-.403.025-.142.05-.278.062-.415.012-.142.025-.285.025-.421 0-.1-.007-.199-.013-.298a6.726 6.726 0 0 0-.05-.415 4.493 4.493 0 0 0-.092-.415c-.044-.13-.087-.267-.137-.397-.05-.13-.111-.26-.173-.384-.069-.124-.137-.248-.211-.366a6.843 6.843 0 0 0-.248-.34c-.093-.106-.186-.212-.285-.317a3.878 3.878 0 0 0-.161-.155c-.28-.217-.57-.421-.862-.607a1.154 1.154 0 0 0-.124-.062 2.415 2.415 0 0 0-.589-.26Z"/></svg></div>
              <span class="text-gray-400">테스트</span>
        </div>
      </div>
      <!-- Header Category End -->
      <div class="w-full flex flex-col justify-start">
        <h1 class="text-2xl md:text-4xl font-semibold mb-2">테스트란 무엇이며 어떻게 할까요?</h1>
        <h2 class="text-sm md:text-xl text-gray-800">NestJS에서 Jest로 테스트코드 작성하기</h2>
      </div>
      <!-- Header Tags And CreatedAt -->
      <div class="flex flex-row text-xs items-center">
        <div class="flex flex-row space-x-1">
          
            <p class="text-[#53C1F8]">#테스트</p>
            
            <p class="text-[#53C1F8]">#TDD</p>
            
            <p class="text-[#53C1F8]">#Jest</p>
            
        </div>
        <div class="text-gray-400 ml-auto">2023년 12월 01일</div>
      </div>
      <!-- Header Tags And CreatedAt End -->
    </div>
    <!-- Post Detail Header End -->
    <!-- Thumbnail -->
    <!-- 썸네일 기능 비활성화
    <div class="w-full max-w-5xl">
      <div class="flex flex-col justify-center items-center rounded-3xl overflow-hidden h-80 w-full hover:drop-shadow-xl transition duration-300 ease-in-out">
        <img src=/feed-thumbnail/object29.jpg alt="Thumbnail" class="w-full h-full object-cover" loading="lazy"></img>
      </div>
    </div>
    -->
    <!-- Thumbnail End -->
    <!-- Content -->
    <div class="flex flex-row w-full max-w-5xl justify-center space-x-2 pt-5">
      <!-- Post Content -->
        <article class="w-full max-w-3xl prose prose-sm md:prose-base overflow-hidden text-gray-700 prose-hr:my-3 prose-pre:bg-gray-900 prose-h1:text-2xl md:prose-h1:text-3xl prose-h1:font-medium prose-h1:mt-8 prose-h1:mb-1 prose-h2:text-xl md:prose-h2:text-2xl prose-h2:font-medium prose-h2:mt-8 prose-h2:mb-1 prose-h3:text-base md:prose-h2:text-xl prose-h3:font-medium prose-h3:mt-8 prose-h3:mb-1">
          <p>저희 서비스는 NestJS 기반으로 다양한 도메인 서비스와 배치작업을 처리하고 있습니다.<br>계속 다양한 요구사항에 대응하고 많은 팀원이 코드를 수정하면서 휴먼 에러가 늘어나<br>테스트 코드의 중요성이 커지게 되었습니다.</p>
<p>오늘은 서비스에 유닛테스트를 도입하게 된 계기와<br>도입하면서 공부한 내용에 대해 공유하고자 합니다.</p>
<h1 id="테스트-유형에-대해"><a href="#테스트-유형에-대해" class="headerlink" title="테스트 유형에 대해"></a>테스트 유형에 대해</h1><hr>
<p>서비스 레이어가 Controller, Service, Repository로 나뉘어 있는 애플리케이션은<br>주로 테스트 범위에 따라 3가지 유형이 존재합니다.</p>
<ul>
<li>Unit Test (단위 테스트)<ul>
<li>Service내에 정의된 메소드, 클래스의 단위 기능을 테스트합니다.</li>
<li>개별 컴포넌트의 동작을 테스트하기 위해 의존성을 격리합니다. (mock)</li>
</ul>
</li>
<li>Integration Test (통합 테스트)<ul>
<li>컴포넌트 간 다양한 상호작용을 테스트합니다.</li>
<li>Controller &lt;-&gt; Service, Service &lt;-&gt; Repository (실제 DB 또는 가상 DB 사용)</li>
</ul>
</li>
<li>E2E Test (종단 테스트)<ul>
<li>실제 사용자 관점에서 전체 시스템(UI 포함)이 예상대로 동작하는지 확인합니다.</li>
</ul>
</li>
</ul>
<h1 id="유닛테스트-도입-배경"><a href="#유닛테스트-도입-배경" class="headerlink" title="유닛테스트 도입 배경"></a>유닛테스트 도입 배경</h1><hr>
<p>테스트 코드 없이 많은 사람이 로직을 작성하고 유지보수 할 때 제가 겪은 문제는 다음과 같았습니다.</p>
<ul>
<li>히스토리 부재<ul>
<li>요구사항이 변화할 경우 코드가 기존 의도와 달라져 사이드 이펙트가 발생했어요.</li>
</ul>
</li>
<li>신뢰성 이슈<ul>
<li>코드리뷰와, 개발자의 개인적인 테스트에만 의존했어요.</li>
</ul>
</li>
<li>갓 객체의 탄생<ul>
<li>동작하는 기능을 빠르게 제공하는 것에만 초점을 두어 하나의 객체가 너무 많은 일을 하게 되었어요.</li>
</ul>
</li>
</ul>
<p>이러한 기술부채에 맞서기 위해 <strong>유닛 테스트</strong>를 도입하고자 했습니다.</p>
<h1 id="유닛테스트를-작성하기-앞서"><a href="#유닛테스트를-작성하기-앞서" class="headerlink" title="유닛테스트를 작성하기 앞서"></a>유닛테스트를 작성하기 앞서</h1><hr>
<p>유닛 테스트의 핵심은 빠르게 하나의 기능(메소드)을 <strong>의존성을 격리</strong>해서 테스트하는 것인데요.<br>본격적으로 유닛테스트를 작성하기 전 다음 두 개의 질문에 부딪히게 됩니다.</p>
<ul>
<li>어떻게 의존성을 격리할 것인지</li>
<li>어디까지 격리할 것인지</li>
</ul>
<h2 id="어떻게-격리할까요"><a href="#어떻게-격리할까요" class="headerlink" title="어떻게 격리할까요?"></a>어떻게 격리할까요?</h2><p>유닛테스트에서는 테스트 더블(Test Double)을 통해<br>의존성 객체들을 대체함으로써 의존성을 격리하게 됩니다.</p>
<p>테스트 더블(Test Double)이란 기능을 동작하는데 필요한 의존성 객체 대신<br>테스트에 사용되는 모든 방법을 말합니다.</p>
<ul>
<li>Dummy<ul>
<li>단순 인스턴스 객체를 리턴하는 객체를 만듭니다.</li>
<li>정상 동작을 보장하지 않습니다.</li>
</ul>
</li>
<li>Stub<ul>
<li>호출 시 사전에 준비된 결과를 리턴합니다.</li>
</ul>
</li>
<li>Mock<ul>
<li>호출 시 기능명세에 따라 완벽히 동작하는 객체를 만들어 결과를 리턴합니다.</li>
</ul>
</li>
<li>Fake<ul>
<li>동작은 하지만 실제 객체처럼 정교하게 동작하지 않는 객체를 만들어 결과를 리턴합니다.</li>
<li><em>ex) Fake DB</em></li>
</ul>
</li>
<li>Spy<ul>
<li>Stub 역할을 하면서 호출되었을 때 상태를 저장하는 기능을 가지는 객체를 만들어 결과를 리턴합니다.</li>
</ul>
</li>
</ul>
<h2 id="어디까지-격리할까요"><a href="#어디까지-격리할까요" class="headerlink" title="어디까지 격리할까요?"></a>어디까지 격리할까요?</h2><p>위에서 테스트 더블을 통해 의존성을 대체하는 방법 대해 알아보았는데요.<br>그럼 어느 정도까지 의존성을 격리하는 게 좋을까요?<br>이에 대해서는 두 가지 견해가 있습니다.</p>
<h3 id="고전파"><a href="#고전파" class="headerlink" title="고전파"></a>고전파</h3><p>하나의 테스트를 기준으로 격리합니다.<br>테스트 간에 공유되고 결과에 영향을 미칠 수 있는 객체만 테스트 더블 합니다. <em>ex) DB</em></p>
<h3 id="런던파"><a href="#런던파" class="headerlink" title="런던파"></a>런던파</h3><p>테스트의 의존성(협력자)을 격리합니다.<br>하나의 테스트가 의존하는 모든 객체를 테스트 더블합니다.</p>
<p>의존성을 테스트 더블 할수록 테스트 단위가 작아진다는 장점이 있지만<br>의존 모듈을 전부 테스트 더블하기 때문에 테스트 코드가 복잡해지고<br>리팩토링 내성을 잃게 되는 단점이 있었습니다.</p>
<h1 id="NestJS에서-Jest로-유닛-테스트-작성하기"><a href="#NestJS에서-Jest로-유닛-테스트-작성하기" class="headerlink" title="NestJS에서 Jest로 유닛 테스트 작성하기"></a>NestJS에서 Jest로 유닛 테스트 작성하기</h1><hr>
<p>저희는 먼저 기존에 테스트 코드가 없지만, 중요도가 높은 로직에 테스트 코드를 먼저 적용했습니다.<br>대표적으로 저희 서비스에서 SQS 메시지를 가져오는 부분을 간단하게 아래에 예시로 작성해 보았습니다.<br>해당 로직과 NestJS <a target="_blank" rel="noopener" href="https://docs.nestjs.com/fundamentals/testing">Jest 문서</a> 기반으로 테스트 코드를 작성해 보겠습니다.</p>
<pre><code class="hljs typescript"><span class="hljs-meta">@Cron</span>(<span class="hljs-string">&#x27;*/15 * * * * *&#x27;</span>, &#123; <span class="hljs-attr">timeZone</span>: <span class="hljs-string">&#x27;Asia/Seoul&#x27;</span> &#125;)

<span class="hljs-keyword">async</span> <span class="hljs-title function_">batch</span>(<span class="hljs-params"></span>) &#123;
  
  <span class="hljs-comment">// 9시 ~ 18시에만 실행</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskService</span>.<span class="hljs-title function_">isWorkTime</span>()) <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">batchMessage</span>: <span class="hljs-string">&#x27;영업시간아님&#x27;</span> &#125;;
  
  <span class="hljs-comment">// SQS에서 메시지를 가져온다.</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">messages</span>: <span class="hljs-title class_">JuiceEvent</span>[] = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sqsProvider</span>.<span class="hljs-title function_">getJuiceMessageAndDelete</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">queryUrl</span>);
  <span class="hljs-keyword">if</span> (messages.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">batchMessage</span>: <span class="hljs-string">&#x27;메시지없음&#x27;</span> &#125;;
  
    
  
  <span class="hljs-keyword">const</span> <span class="hljs-attr">failedMessages</span>: <span class="hljs-title class_">JuiceEvent</span>[] = [];
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> messages) &#123;
    <span class="hljs-keyword">const</span> &#123; actCode, contractNum, provider &#125; = message;
    <span class="hljs-keyword">try</span> &#123;
      <span class="hljs-keyword">switch</span> (actCode) &#123;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;NAC&#x27;</span>: &#123;
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskService</span>.<span class="hljs-title function_">registerLine</span>(provider, contractNum);
        <span class="hljs-keyword">break</span>;
      &#125;
      <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;CCN&#x27;</span>: &#123;
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskService</span>.<span class="hljs-title function_">changeLine</span>(provider, contractNum);
        <span class="hljs-keyword">break</span>;
      &#125;
      <span class="hljs-attr">default</span>: &#123;
        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">$&#123;actCode&#125;</span>][<span class="hljs-subst">$&#123;contractNum&#125;</span>] 알 수 없는 actCode 입니다.`</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">LOG_CONTEXT</span>);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`알 수 없는 actCode 입니다. [<span class="hljs-subst">$&#123;actCode&#125;</span>]`</span>);
      &#125;
    &#125;
    &#125; <span class="hljs-keyword">catch</span> (error) &#123;
      failedMessages.<span class="hljs-title function_">push</span>(message);
    &#125;
  &#125;
  
  <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">batchMessage</span>: <span class="hljs-string">&#x27;작업 종료&#x27;</span>, failedMessages &#125;;

&#125;</code></pre>
<p>해당 로직은 SQS에서 메시지를 가져오고 메시지의 이벤트 코드를 보고<br>적절한 비즈니스 로직에 메시지를 전달하는 책임을 가지고 있는 객체입니다.<br>자세한 요구사항을 항목으로 정리하면 다음과 같습니다.</p>
<ul>
<li>9시 ~ 18시에만 실행됩니다.</li>
<li>각 <code>actCode</code>에 맞는 비즈니스 로직을 호출합니다.</li>
<li>처리에 실패한 메시지는 작업 결과와 함께 반환되어야 합니다.</li>
</ul>
<h2 id="테스트-코드-작성하기"><a href="#테스트-코드-작성하기" class="headerlink" title="테스트 코드 작성하기"></a>테스트 코드 작성하기</h2><h3 id="클래스-의존성-테스트-더블하기"><a href="#클래스-의존성-테스트-더블하기" class="headerlink" title="클래스 의존성 테스트 더블하기"></a>클래스 의존성 테스트 더블하기</h3><pre><code class="hljs typescript"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;TestBatch&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">testBatch</span>: <span class="hljs-title class_">TestBatch</span>;
  <span class="hljs-keyword">const</span> taskServiceMock = &#123; <span class="hljs-attr">registerLine</span>: jest.<span class="hljs-title function_">fn</span>(), <span class="hljs-attr">changeLine</span>: jest.<span class="hljs-title function_">fn</span>() &#125;;
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">SqsV3ProviderMock</span> = &#123; <span class="hljs-attr">getJuiceMessageAndDelete</span>: jest.<span class="hljs-title function_">fn</span>() &#125;;
  
  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; &#123;
    <span class="hljs-keyword">const</span> moduleRef = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Test</span>.<span class="hljs-title function_">createTestingModule</span>(&#123;
    <span class="hljs-attr">providers</span>: [
      <span class="hljs-title class_">TestBatch</span>,
      &#123; <span class="hljs-attr">provide</span>: <span class="hljs-title class_">SqsV3Provider</span>, <span class="hljs-attr">useValue</span>: <span class="hljs-title class_">SqsV3ProviderMock</span> &#125;,
      &#123; <span class="hljs-attr">provide</span>: <span class="hljs-title class_">TaskService</span>, <span class="hljs-attr">useValue</span>: <span class="hljs-title class_">TaskServiceMock</span> &#125;,
    ],
  &#125;).<span class="hljs-title function_">compile</span>();
  
  
  testBatch = moduleRef.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">TestBatch</span>&gt;(<span class="hljs-title class_">TestBatch</span>);
&#125;);
</code></pre>
<p><code>TestBatch</code> 클래스에서 사용하는 <code>SqsV3Provider</code> <code>TaskService</code> 메소드를 Jest Mocking 객체로 대체해 주었습니다.</p>
<h2 id="영업시간-체크로직-테스트하기"><a href="#영업시간-체크로직-테스트하기" class="headerlink" title="영업시간 체크로직 테스트하기"></a>영업시간 체크로직 테스트하기</h2><pre><code class="hljs typescript"><span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;영업 시간(9시 ~ 18시)이 아니면 프로세스를 종료합니다.&#x27;</span>, <span class="hljs-keyword">async</span> () =&gt; &#123;
  <span class="hljs-comment">// given</span>
  <span class="hljs-comment">// 영업 시간이 아니라고 가정</span>
  <span class="hljs-keyword">const</span> fakeNowTime = <span class="hljs-title class_">DateTime</span>.<span class="hljs-title function_">fromISO</span>(<span class="hljs-string">&#x27;2023-01-01T08:00:00Z&#x27;</span>); <span class="hljs-comment">// utc 기준</span>
  jest.<span class="hljs-title function_">useFakeTimers</span>();
  jest.<span class="hljs-title function_">setSystemTime</span>(fakeNowTime.<span class="hljs-title function_">toJSDate</span>());
  
  <span class="hljs-comment">// when</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> testBatch.<span class="hljs-title function_">batch</span>();
  
  <span class="hljs-comment">// then</span>
  <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toEqual</span>(&#123; <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">batchMessage</span>: <span class="hljs-string">&#x27;영업시간아님&#x27;</span> &#125;);
&#125;);</code></pre>
<p>영업시간이 아닐 경우 종료 처리되는 결과를 테스트하기 위한 코드를 작성해주었습니다.</p>
<p>시간에 영향을 받는 로직의 경우 Jest의 <code>setSystemTime</code>을 사용하면 의도한 시간대로 시간을 고정할 수 있었어요.</p>
<h2 id="SQS-메시지-조회-테스트하기"><a href="#SQS-메시지-조회-테스트하기" class="headerlink" title="SQS 메시지 조회 테스트하기"></a>SQS 메시지 조회 테스트하기</h2><pre><code class="hljs typescript"><span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;SQS에서 메시지를 가져오지 못하면 프로세스를 종료합니다.&#x27;</span>, <span class="hljs-keyword">async</span> () =&gt; &#123;
  <span class="hljs-comment">// given</span>
  <span class="hljs-title class_">SqsV3ProviderMock</span>.<span class="hljs-property">getJuiceMessageAndDelete</span>.<span class="hljs-title function_">mockResolvedValue</span>([]);
  
  <span class="hljs-comment">// when</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> testBatch.<span class="hljs-title function_">batch</span>();
  
  <span class="hljs-comment">// then</span>
  <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toEqual</span>(&#123; <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">batchMessage</span>: <span class="hljs-string">&#x27;메시지없음&#x27;</span> &#125;);
&#125;);</code></pre>
<p>다음으로 처리할 메시지가 없으면 로직을 종료해야 하는 요구사항을 테스트하기 위한 코드를 작성했습니다.</p>
<p>메시지를 가져오는 메소드를 <code>mockResolvedValue</code> 를 사용해서 <code>stub</code> 해주었습니다.</p>
<h2 id="처리-불가능한-이벤트-처리-테스트하기"><a href="#처리-불가능한-이벤트-처리-테스트하기" class="headerlink" title="처리 불가능한 이벤트 처리 테스트하기"></a>처리 불가능한 이벤트 처리 테스트하기</h2><pre><code class="hljs typescript"><span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;SQS에서 처리 불가능한 메시지가 있을 경우 failedMessages에 담아서 리턴합니다.&#x27;</span>, <span class="hljs-keyword">async</span> () =&gt; &#123;
  <span class="hljs-comment">// given</span>
  <span class="hljs-comment">// 처리 불가능한 임의의 actCode를 가진 메시지</span>
  <span class="hljs-keyword">const</span> failedMessages = [
  &#123; <span class="hljs-attr">actCode</span>: <span class="hljs-string">&#x27;TEST1&#x27;</span>, <span class="hljs-attr">contractNum</span>: <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-attr">provider</span>: <span class="hljs-string">&#x27;SKT&#x27;</span> &#125;,
  &#123; <span class="hljs-attr">actCode</span>: <span class="hljs-string">&#x27;TEST2&#x27;</span>, <span class="hljs-attr">contractNum</span>: <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-attr">provider</span>: <span class="hljs-string">&#x27;SKT&#x27;</span> &#125;,
  ];
<span class="hljs-title class_">SqsV3ProviderMock</span>.<span class="hljs-property">getJuiceMessageAndDelete</span>.<span class="hljs-title function_">mockResolvedValue</span>(failedMessages);
  
  <span class="hljs-comment">// when</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> testBatch.<span class="hljs-title function_">batch</span>();
  
  <span class="hljs-comment">// then</span>
  <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toEqual</span>(&#123; <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">batchMessage</span>: <span class="hljs-string">&#x27;작업 종료&#x27;</span>, failedMessages &#125;);
&#125;);</code></pre>
<p>처리 불가능한 <code>actCode</code>가 존재할 경우 작업 종료할 때 해당 메시지들을<br><code>failedMessages</code>에 담아 리턴하는 요구사항을 테스트하기 위한 코드를 작성했습니다.</p>
<h2 id="올바른-로직-호출여부-테스트하기"><a href="#올바른-로직-호출여부-테스트하기" class="headerlink" title="올바른 로직 호출여부 테스트하기"></a>올바른 로직 호출여부 테스트하기</h2><pre><code class="hljs typescript"><span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;NAC 이벤트를 받으면 registerLine(회선 등록)을 호출합니다.&#x27;</span>, <span class="hljs-keyword">async</span> () =&gt; &#123;
  <span class="hljs-comment">// given</span>
  <span class="hljs-keyword">const</span> messages = [&#123; <span class="hljs-attr">actCode</span>: <span class="hljs-string">&#x27;NAC&#x27;</span>, <span class="hljs-attr">contractNum</span>: <span class="hljs-string">&#x27;123&#x27;</span>, <span class="hljs-attr">provider</span>: <span class="hljs-string">&#x27;SKT&#x27;</span> &#125;];
  <span class="hljs-title class_">SqsV3ProviderMock</span>.<span class="hljs-property">getJuiceMessageAndDelete</span>.<span class="hljs-title function_">mockResolvedValue</span>(messages);

  <span class="hljs-comment">// when</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> testBatch.<span class="hljs-title function_">batch</span>();

  <span class="hljs-comment">// then</span>
  <span class="hljs-title function_">expect</span>(result).<span class="hljs-title function_">toEqual</span>(&#123; <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">batchMessage</span>: <span class="hljs-string">&#x27;작업 종료&#x27;</span>, <span class="hljs-attr">failedMessages</span>: [] &#125;);
  <span class="hljs-title function_">expect</span>(taskServiceMock.<span class="hljs-property">registerLine</span>).<span class="hljs-title function_">toBeCalledTimes</span>(<span class="hljs-number">1</span>);
  <span class="hljs-title function_">expect</span>(taskServiceMock.<span class="hljs-property">registerLine</span>).<span class="hljs-title function_">toBeCalledWith</span>(<span class="hljs-string">&#x27;SKT&#x27;</span>, <span class="hljs-string">&#x27;123&#x27;</span>);
&#125;);
</code></pre>
<p>각 <code>actCode</code> 이벤트별로 올바른 로직을 호출했는지 테스트하기 위한 코드를 작성했습니다.<br>해당 비즈니스 로직에서는 어떤 행위를 했는지가 중요하므로 다음과 같이 진행했습니다.</p>
<p>대부분의 경우 로직의 행위보다는 결과에 집중해야 리팩토링 내성을 잃지 않을 수 있음을 명심하고 진행해야 합니다!</p>
<h1 id="마치며"><a href="#마치며" class="headerlink" title="마치며"></a>마치며</h1><hr>
<p>저희 서비스에서 테스트 코드를 도입하는 과정에서 공부한 내용과 적용과정을 간단하게 정리했습니다!</p>
<p>서비스에 유닛테스트를 적용하면서 생각한 <strong>장점</strong>은 다음과 같았어요</p>
<ul>
<li>객체의 역할과 책임에 집중할 수 있습니다.<ul>
<li>객체가 너무 많은 책임을 지고 있는 것이 아닌지 생각해 볼 수 있었어요.</li>
</ul>
</li>
<li>코드에 드러나지 않은 요구사항을 명시합니다.<ul>
<li>로직적으로 풀어낸 요구사항을 테스트 케이스를 통해 의도한 바를 명확하게 전달할 수 있었어요.</li>
</ul>
</li>
<li>코드의 신뢰성을 확보할 수 있습니다.<ul>
<li>테스트하기 어려운 환경을 재현하여 테스트할 수 있었어요. <em>ex) 시간</em></li>
</ul>
</li>
</ul>
<p>제가 느낀 유닛테스트의 <strong>단점</strong>은 다음과 같았어요</p>
<ul>
<li>작업량이 늘어납니다.</li>
<li>테스트 코드가 있는 코드는 테스트만 통과하면 코드를 무조건 신뢰하는 경향이 있습니다.<ul>
<li>테스트 코드는 완벽하지 않으며 꾸준히 반례를 추가해 나가야 합니다.</li>
</ul>
</li>
<li>거의 모든 비즈니스 로직은 공유 의존성을 가지기 때문에 테스트하기 어렵습니다.<ul>
<li>Repository 계층의 상호작용을 테스트할 경우 Fake DB(In-memory Database)가 필요합니다.</li>
<li>행동 기반(호출 횟수, 매개변수 검증)으로 테스트할 경우 리팩토링 내성을 잃습니다.</li>
</ul>
</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><hr>
<p><a target="_blank" rel="noopener" href="https://tecoble.techcourse.co.kr/post/2020-09-19-what-is-test-double/">https://tecoble.techcourse.co.kr/post/2020-09-19-what-is-test-double/</a><br><a target="_blank" rel="noopener" href="https://martinfowler.com/articles/mocksArentStubs.html">https://martinfowler.com/articles/mocksArentStubs.html</a><br><a target="_blank" rel="noopener" href="https://jestjs.io/docs/api#beforeallfn-timeout">https://jestjs.io/docs/api#beforeallfn-timeout</a><br><a target="_blank" rel="noopener" href="https://docs.nestjs.com/fundamentals/testing">https://docs.nestjs.com/fundamentals/testing</a></p>

        </article>
        <!-- Post Content End -->
    </div>
    <!-- Content End -->
</div>
    <!-- PostDetail End -->
    
<footer class="flex flex-col w-full justify-center items-center mt-28 py-16 px-5 bg-gray-50">
    <div class="flex flex-col w-full max-w-5xl space-y-1">
        <div class="flex flex-row text-sm font-semibold text-gray-400 items-center space-x-1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12.75 3.03v.568c0 .334.148.65.405.864l1.068.89c.442.369.535 1.01.216 1.49l-.51.766a2.25 2.25 0 01-1.161.886l-.143.048a1.107 1.107 0 00-.57 1.664c.369.555.169 1.307-.427 1.605L9 13.125l.423 1.059a.956.956 0 01-1.652.928l-.679-.906a1.125 1.125 0 00-1.906.172L4.5 15.75l-.612.153M12.75 3.031a9 9 0 00-8.862 12.872M12.75 3.031a9 9 0 016.69 14.036m0 0l-.177-.529A2.25 2.25 0 0017.128 15H16.5l-.324-.324a1.453 1.453 0 00-2.328.377l-.036.073a1.586 1.586 0 01-.982.816l-.99.282c-.55.157-.894.702-.8 1.267l.073.438c.08.474.49.821.97.821.846 0 1.598.542 1.865 1.345l.215.643m5.276-3.67a9.012 9.012 0 01-5.276 3.67m0 0a9 9 0 01-10.275-4.835M15.75 9c0 .896-.393 1.7-1.016 2.25" />
              </svg>              
              <span class="">Created By Argon1025 (argon1025@gmail.com)</span>
        </div>
        <div class="flex flex-row text-sm text-gray-400 items-center space-x-1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
              </svg>
              <span class="">Special thanks | Feed Thumbnail By Milad Fakurian</span>
        </div>
    </div>
</footer>
  </body>
</html>